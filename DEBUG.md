# Node.js 服务器调试指南

本文档介绍如何调试 Node.js 服务器端代码。

## 方法一：使用 VS Code 调试器（推荐）

### 1. 启动调试模式

在 VS Code 中：
1. 按 `F5` 或点击左侧调试面板（🐛图标）
2. 选择 "启动服务器（调试模式）"
3. 点击绿色播放按钮或按 `F5`

### 2. 设置断点

- 在代码行号左侧点击，会出现红色圆点（断点）
- 当代码执行到断点时，程序会暂停
- 可以查看变量值、调用栈等信息

### 3. 调试控制

- **继续执行** (`F5`): 继续执行到下一个断点
- **单步跳过** (`F10`): 执行当前行，不进入函数内部
- **单步进入** (`F11`): 进入函数内部
- **单步跳出** (`Shift+F11`): 跳出当前函数
- **重启** (`Ctrl+Shift+F5`): 重启调试会话
- **停止** (`Shift+F5`): 停止调试

### 4. 使用 nodemon 自动重启调试

选择 "使用 nodemon 调试（自动重启）" 配置：
- 代码修改后自动重启服务器
- 适合开发时使用

## 方法二：使用命令行调试

### 1. 基础调试模式

```bash
npm run debug
```

服务器会启动在调试模式，默认端口 `9229`。

### 2. 在首行暂停

```bash
npm run debug-brk
```

程序会在第一行暂停，等待调试器连接。

### 3. 使用 nodemon 调试

```bash
npm run dev-debug
```

代码修改后自动重启，并保持调试模式。

### 4. 连接 Chrome DevTools

1. 启动调试模式后，打开 Chrome 浏览器
2. 访问 `chrome://inspect`
3. 点击 "Open dedicated DevTools for Node"
4. 可以在浏览器中设置断点和调试

## 方法三：附加到运行中的进程

如果服务器已经在运行（使用 `npm start` 或 `npm run dev`）：

1. 使用 `--inspect` 参数启动：
   ```bash
   node --inspect server.js
   ```

2. 在 VS Code 中选择 "附加到运行中的进程" 配置
3. 点击调试按钮

## 调试技巧

### 1. 查看变量值

- 在调试面板的 "变量" 区域查看局部变量和全局变量
- 鼠标悬停在代码上查看变量值
- 在 "监视" 区域添加表达式

### 2. 查看调用栈

在 "调用堆栈" 区域可以看到函数调用链，了解代码执行路径。

### 3. 使用 console.log

虽然调试器很强大，但有时简单的 `console.log` 也很有用：

```javascript
console.log('变量值:', variable);
console.error('错误信息:', error);
```

### 4. 条件断点

右键点击断点，可以设置条件，只有满足条件时才会暂停。

### 5. 日志点

右键点击断点，选择 "编辑断点" -> "日志点"，可以在不暂停的情况下输出日志。

## 环境变量

确保 `.env` 文件存在并包含必要的环境变量：
- `PORT`: 服务器端口（默认 3000）
- `APP_ID`: 飞书应用 ID
- `APP_SECRET`: 飞书应用密钥
- `APP_TOKEN`: 飞书多维表格应用 token
- `TABLE_ID`: 飞书多维表格 ID

## 常见问题

### 1. 端口被占用

如果调试端口 9229 被占用，可以修改 `launch.json` 中的端口配置。

### 2. 无法连接调试器

确保防火墙允许端口 9229，或者使用不同的端口。

### 3. 断点不生效

- 确保代码已保存
- 检查断点是否在可执行代码行（不是注释或空行）
- 如果使用 nodemon，确保配置正确

## 推荐的调试流程

1. **开发阶段**: 使用 "使用 nodemon 调试（自动重启）" 配置
2. **问题排查**: 使用 "启动服务器（调试模式）" 设置断点
3. **生产问题**: 使用 `--inspect` 附加到运行中的进程

## 相关资源

- [Node.js 调试指南](https://nodejs.org/en/docs/guides/debugging-getting-started/)
- [VS Code 调试文档](https://code.visualstudio.com/docs/nodejs/nodejs-debugging)

